## å…ˆæ¥çœ‹å®éªŒè¦æ±‚
**è®¾è®¡å®ç°ä¸€ä¸ªåŸºäºWin32çš„åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬å¦‚ä¸‹åŠŸèƒ½ï¼ˆæ»¡åˆ†100åˆ†ï¼‰ï¼š**
- èƒ½å¤Ÿé€šè¿‡æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†é€‰å®šä¸¤ä¸ªè§†é¢‘æ–‡ä»¶ã€‚å¦‚æœä½ ä½¿ç”¨OpenCVåˆ™å¯ä»¥é€‰æ‹©å¸¸è§„çš„mp4æˆ–aviæ ¼å¼è§†é¢‘ï¼›å¦‚æœä½ ä¸ä½¿ç”¨OpenCVåˆ™å»ºè®®è½½å…¥yuvè§†é¢‘ã€‚æˆ‘ä»¬åœ¨ç¬¬åäºŒå‘¨çš„å®éªŒä»£ç å‹ç¼©åŒ…â€œYUVè§†é¢‘æ’­æ”¾çš„å‚è€ƒä»£ç å’ŒYUVè§†é¢‘æ–‡ä»¶.zipâ€ä¸­åŒ…å«äº†ä¸¤ä¸ªyuvè§†é¢‘æ–‡ä»¶ï¼Œå¯ä¾›ä½ ä½¿ç”¨ã€‚ï¼ˆå 10åˆ†ï¼‰
- èƒ½é€šè¿‡èœå•é€‰æ‹©ä»»æ„ä¸€ä¸ªè§†é¢‘è¿›è¡Œæ’­æ”¾ï¼ˆå 10åˆ†ï¼‰ï¼Œå…·æœ‰æ’­æ”¾ï¼ˆå 10åˆ†ï¼‰ã€æš‚åœï¼ˆå 10åˆ†ï¼‰ã€åœæ­¢åŠŸèƒ½ï¼ˆå 10åˆ†ï¼‰ã€‚
- èƒ½é€šè¿‡èœå•é€‰æ‹©ç”»ä¸­ç”»æ•ˆæœï¼Œå³åœ¨æ’­æ”¾æŸä¸€ä¸ªè§†é¢‘æ—¶ï¼ŒåŒæ—¶æŠŠå¦å¤–ä¸€ä¸ªè§†é¢‘ç¼©å°è‡³å‰ä¸€ä¸ªè§†é¢‘ç”»é¢çš„å³ä¸Šè§’ä¸€åŒæ’­æ”¾ï¼ˆå 30åˆ†ï¼Œå…¶ä¸­ç¼©å°å 10åˆ†ã€å³ä¸Šè§’å 10åˆ†ã€ä¸€åŒæ’­æ”¾å 10åˆ†ï¼‰ã€‚åœ¨ç”»ä¸­ç”»æ’­æ”¾è¿‡ç¨‹ä¸­ï¼Œä»»æ„è§†é¢‘å¦‚æœæ’­æ”¾åˆ°ç»“å°¾ï¼Œè¯¥è§†é¢‘å°±ä»å¤´é‡æ’­ï¼Œå‘¨è€Œå¤å§‹ï¼ˆå 20åˆ†ï¼Œå…¶ä¸­è‹¥ä¸¤ä¸ªè§†é¢‘éƒ½èƒ½åˆ†åˆ«å‘¨è€Œå¤å§‹æ’­æ”¾ç»™20åˆ†ï¼Œè‹¥åªæœ‰ä¸€ä¸ªå¯ä»¥åˆ™ç»™10åˆ†ï¼‰ã€‚
- å¦‚æœå®ç°äº†é¢å¤–çš„è§†é¢‘æ•ˆæœï¼Œåˆ™æœ€å¤šå¯ä»¥å¥–åŠ±15åˆ†ã€‚å¯ä»¥é€‰æ‹©çš„è§†é¢‘æ•ˆæœï¼š
	- 1.å¯ä»¥ç”¨é¼ æ ‡æ‹–æ‹½çš„æ–¹å¼æ”¹å˜ç”»ä¸­ç”»çš„å°è§†é¢‘çš„ä½ç½®ï¼ˆ5åˆ†ï¼‰ï¼›
	- 2.å¯ä»¥ç”¨é¼ æ ‡åœ¨è§†é¢‘ç”»é¢ä¸Šç»˜åˆ¶çº¿æ¡ï¼ˆ5åˆ†ï¼‰
	- 3.å¯ä»¥å°†ç”»ä¸­ç”»çš„å°è§†é¢‘æ”¹ä¸ºè¾¹ç¼˜å›¾æ˜¾ç¤ºï¼ˆå³æ˜¾ç¤ºå…¶ç”»é¢çš„è¾¹ç¼˜å›¾è€Œä¸æ˜¯åŸå›¾ï¼‰ï¼ˆ5åˆ†ï¼‰

## å†æ¥çœ‹ç»™å‡ºçš„ä»£ç æ¨¡æ¿
- yuvæ ¼å¼è¯»å–å·²å®ç°å†…å®¹
	- æ’­æ”¾è§†é¢‘fireman.yuvï¼ˆè·¯å¾„è¿˜éœ€è¦è‡ªå·±æ”¹æˆç»å¯¹è·¯å¾„ï¼‰
- mp4æ ¼å¼è¯»å–å·²å®ç°å†…å®¹
	- è§†é¢‘æ–‡ä»¶é€‰æ‹©
	- è§†é¢‘æ–‡ä»¶æ’­æ”¾æš‚åœåœæ­¢
	- è§†é¢‘æ–‡ä»¶è¾¹ç¼˜å›¾æ˜¾ç¤º

å¾ˆæ˜æ˜¾ï¼Œmp4æ ¼å¼è¯»å–ï¼Œä¹Ÿå°±æ˜¯OpenCVçš„æ¨¡æ¿æ›´å…¨ğŸ¶
é‚£æˆ‘è‚¯å®šé€‰**OpenCV**äº†ï¼

**[å®éªŒä»£ç åœ¨è¿™é‡Œ](https://github.com/Southyang/CSU-HW/tree/master/%E5%A4%A7%E4%B8%89/MultiMedia)**
**[å®éªŒè§†é¢‘ä¼ åˆ°Bç«™å•¦](https://www.bilibili.com/video/BV1wY4y1r7St/)**

## æ­£å¼å¼€å§‹è¿›è¡Œå®éªŒè®¾è®¡
### 1. ç¯å¢ƒé…ç½®
é€‰OpenCVå”¯ä¸€çš„é—®é¢˜å°±æ˜¯è¦é…ç½®ç¯å¢ƒ
è¯¦ç»†é…ç½®è§æˆ‘çš„å¦ä¸€ç¯‡åšå®¢[OpenCVç¯å¢ƒé…ç½®](https://southyang.cn/2022/05/02/%e5%9c%a8vs2019%e4%b8%ad%e9%85%8d%e7%bd%aeopencv/)

### 2. é€‰å®šä¸¤ä¸ªè§†é¢‘æ–‡ä»¶å¹¶è¿›è¡Œæ’­æ”¾ã€æš‚åœã€åœæ­¢
åªéœ€è¦æ¨¡ä»¿ä»£ç æ¨¡æ¿ä¸­çš„æ–‡ä»¶é€‰æ‹©ã€çŠ¶æ€æ“ä½œå³å¯
```cpp
// å‚æ•°å®šä¹‰
cv::Mat img1;                                   // è§†é¢‘1å¸§
cv::Mat img2;                                   // è§†é¢‘2å¸§
WCHAR FileNameOfVideo1[1024];                   // è§†é¢‘1çš„æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶å
WCHAR FileNameOfVideo2[1024];                   // è§†é¢‘2çš„æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶å
cv::VideoCapture VidCap1;                       // è§†é¢‘1çš„è¯»å–å™¨
cv::VideoCapture VidCap2;                       // è§†é¢‘2çš„è¯»å–å™¨
```
```cpp
// é€‰æ‹©æ–‡ä»¶
case IDM_OPEN_VID1:                
    result = OpenVideoFile(hWnd, &fn1);
    if (result)
    {
        //img1 = cv::imread(WCHAR2String(fn1));
        bool opened = VidCap1.open(WCHAR2String(fn1));
        frameNum1 = VidCap1.get(cv::CAP_PROP_FRAME_COUNT); // è·å–æ€»å¸§æ•°
        if (opened)
        {
            VidCap1 >> img1; //è·å–ç¬¬ä¸€å¸§å›¾åƒå¹¶æ˜¾ç¤º

            //æ¿€å‘WM_PAINTæ—¶é—´ï¼Œè®©çª—å£é‡ç»˜
            InvalidateRect(hWnd, NULL, false);
        }
        else
        {
            MessageBox(
                hWnd,
                L"è§†é¢‘æœªèƒ½æ‰“å¼€",
                L"é”™è¯¯æç¤º",
                MB_OK
            );
        }
    }
    break;
case IDM_OPEN_VID2:
    result = OpenVideoFile(hWnd, &fn2);
    if (result)
    {
        bool opened = VidCap2.open(WCHAR2String(fn2));
        frameNum2 = VidCap2.get(cv::CAP_PROP_FRAME_COUNT); // è·å–æ€»å¸§æ•°
        if (opened)
        {
            VidCap2 >> img2; //è·å–ç¬¬äºŒå¸§å›¾åƒå¹¶æ˜¾ç¤º

            //æ¿€å‘WM_PAINTæ—¶é—´ï¼Œè®©çª—å£é‡ç»˜
            InvalidateRect(hWnd, NULL, false);
        }
        else
        {
            MessageBox(
                hWnd,
                L"è§†é¢‘æœªèƒ½æ‰“å¼€",
                L"é”™è¯¯æç¤º",
                MB_OK
            );
        }
    }
    bre
```
```cpp
// æ’­æ”¾çŠ¶æ€
case IDM_PLAY_VID:
    playState1 = PlayState::playing;
    break;
case IDM_PAUSE_VID:
    playState1 = PlayState::paused;
    break;
case IDM_STOP_VID:
    playState1 = PlayState::stopped;
    VidCap1.set(cv::VideoCaptureProperties::CAP_PROP_POS_FRAMES, 0);                
    break;
case IDM_PLAY_VID2:
    playState2 = PlayState::playing;
    break;
case IDM_PAUSE_VID2:
    playState2 = PlayState::paused;
    break;
case IDM_STOP_VID2:
    playState2 = PlayState::stopped;
    VidCap2.set(cv::VideoCaptureProperties::CAP_PROP_POS_FRAMES, 0);
    bre
```
```cpp
// è®¡æ—¶å™¨å‘å¸ƒæ¶ˆæ¯
case WM_TIMER: // å½“è®¡æ—¶å™¨è¿‡æœŸæ—¶ï¼Œå‘å¸ƒåˆ°æ­£åœ¨å®‰è£…çš„çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ æ¶ˆæ¯ç”± GetMessage æˆ– PeekMessage å‡½æ•°å‘å¸ƒã€‚
    if (VidCap1.isOpened() && playState1 == PlayState::playing)
    {
        VidCap1 >> img1;
        if (++frameNow1 >= frameNum1 - 1) {
            frameNow1 = 0;
            VidCap1.set(cv::VideoCaptureProperties::CAP_PROP_POS_FRAMES, 0);
        }
        if (img1.empty() == false)
        {
            if (vidEffect1 == VideoEffect::edge)
            {                    
                cv::Mat edgeY, edgeX;
                cv::Sobel(img1, edgeY, CV_8U, 1, 0);
                cv::Sobel(img1, edgeX, CV_8U, 0, 1);
                img1 = edgeX + edgeY;
            }

            InvalidateRect(hWnd, NULL, false);
        }
    }
    if (VidCap2.isOpened() && playState2 == PlayState::playing)
    {
        VidCap2 >> img2;
        if (++frameNow2 >= frameNum2 - 1) {
            frameNow2 = 0;
            VidCap2.set(cv::VideoCaptureProperties::CAP_PROP_POS_FRAMES, 0);
        }
        if (img2.empty() == false)
        {
            if (vidEffect2 == VideoEffect::edge)
            {
                cv::Mat edgeY, edgeX;
                cv::Sobel(img2, edgeY, CV_8U, 1, 0);
                cv::Sobel(img2, edgeX, CV_8U, 0, 1);
                img2 = edgeX + edgeY;
            }

            InvalidateRect(hWnd, NULL, false);
        }
    }
    break;
```
```cpp
// ç»˜åˆ¶
int wWidth = rect.right - rect.left;
int wHeight = rect.bottom - rect.top;
int width1 = wWidth / 2;
int x1 = 0;

if (img1.cols != 0) {
    PlayVideo(img1, hdc1, hWnd, x1, 0, width1, width1 * img1.rows / img1.cols);
}

if (img2.cols != 0) {
    width2 = wWidth / 2;
    x2 = width1;
    height2 = width2 * img2.rows / img2.cols;
    y2 = 0;
    PlayVideo(img2, hdc1, hWnd, x2, y2, width2, height2);
}
```
### 3. å®ç°ç”»ä¸­ç”»æ¨¡å¼
ç”»ä¸­ç”»å°±æ˜¯æ”¹å˜ä¸¤ä¸ªè§†é¢‘çš„é•¿å®½å’Œå·¦ä¸Šè§’ä½ç½®
ä¾‹å¦‚ï¼Œæ™®é€šæ¨¡å¼æ˜¯ä¸¤ä¸ªè§†é¢‘å¹³åˆ†ç¨‹åºçª—å£çš„å®½ï¼Œåœ¨ç”»ä¸­ç”»æ¨¡å¼ä¸‹ï¼Œä¸»è§†é¢‘å æ®ä¸»ä½“ï¼Œå°†å°è§†é¢‘ç¼©å°åˆ°ä¸»è§†é¢‘å·¦ä¸Šè§’
å³å°†ä¸»è§†é¢‘çš„é«˜è®¾ä¸ºçª—å£é«˜åº¦ï¼Œå®½åº¦æ ¹æ®è§†é¢‘å¸§è®¡ç®—ï¼›
å°†å°è§†é¢‘çš„é«˜è®¾ä¸ºçª—å£çš„2/5ï¼Œå®½åº¦æ ¹æ®è§†é¢‘å¸§è®¡ç®—ï¼›
```cpp
// è®¾å®šå‚æ•°å’ŒçŠ¶æ€
// ç”»ä¸­ç”»å‚æ•°
int width2, height2;                            // è§†é¢‘æ–‡ä»¶2çš„é•¿å®½
int x2, y2;                                     // è§†é¢‘æ–‡ä»¶2çš„ä½ç½®
HDC hdc2;                                       // è§†é¢‘æ–‡ä»¶2çš„hdc

enum PiPState {
    noPip, pip                                     
};
PiPState pipState = PiPState::noPip;             // ç”»ä¸­ç”»çŠ¶æ€
```
```cpp
// ä¿®æ”¹çŠ¶æ€
case IDM_INSERT_VID:
    if (pipState == PiPState::pip) {
        pipState = PiPState::noPip;
    }
    else {
        pipState = PiPState::pip;
    }
    break;
```
```cpp
// æ”¹å˜é•¿å®½å’Œåæ ‡
if (pipState == PiPState::pip) {
    if (img1.cols != 0 && img2.cols != 0) {
        int wWidth = rect.right - rect.left;
        int wHeight = rect.bottom - rect.top;
        int width1 = img1.cols * wHeight / img1.rows;
        int x1 = (wWidth - width1) / 2;
        PlayVideo(img1, hdc1, hWnd, x1, 0, width1, wHeight);
        width2 = img2.cols * wHeight / img2.rows / 2.5;

        if (dragState == DragState::noDrag) {
            x2 = wWidth - x1 - width2;
            y2 = 0;
            height2 = wHeight / 2.5;
        }
        else {
            if (isDrag) {
                x2 += nowX - lastX;
                y2 += nowY - lastY;
                lastX = nowX;
                lastY = nowY;
            }
        }

        PlayVideo(img2, hdc1, hWnd, x2, y2, width2, height2);
    }
}
```
### 4. å¾ªç¯åå¤æ’­æ”¾
å¾ªç¯æ’­æ”¾çš„åŸç†æ˜¯ï¼Œå½“æ£€æµ‹åˆ°å½“å‰è§†é¢‘å¸§å·²ç»å…¨éƒ¨æ’­æ”¾å®Œä¹‹åï¼Œä»å¤´å¼€å§‹
å½“å‰çš„çŠ¶æ€æ˜¯ï¼Œè§†é¢‘æ’­æ”¾åˆ°äº†æœ€åå°±ä¼šä¸€ç›´åœç•™åœ¨æœ€åä¸€å¸§ä¸å†æ’­æ”¾ï¼›å¹¶ä¸”ç”»ä¸­ç”»æ¨¡å¼ä¸‹ï¼Œè¾ƒçŸ­çš„è§†é¢‘åœæ­¢åä¼šå°†å¦ä¸€ä¸ªä¹Ÿåœæ­¢
é‚£ä¹ˆæˆ‘ä»¬å°±è¦ç»Ÿè®¡æ¯ä¸€ä¸ªè§†é¢‘çš„å¸§æ•°å¹¶è¿›è¡Œè®°å½•ï¼Œå¦‚æœå½“å‰æ˜¯æœ€åä¸€å¸§ï¼Œé‚£ä¹ˆå°±ä»å¤´æ’­æ”¾ï¼›å¦åˆ™ç»§ç»­æ’­æ”¾
```cpp
// è®¾å®šå‚æ•°
int frameNum1;                                  // è§†é¢‘1å¸§æ•°
int frameNum2;                                  // è§†é¢‘2å¸§æ•°
int frameNow1 = 0;                              // è§†é¢‘1å½“å‰å¸§æ•°
int frameNow2 = 0;                              // è§†é¢‘2å½“å‰å¸§æ•°
```
```cpp
// åˆ¤æ–­å¸§æ•°ï¼Œä¸¤ä¸ªè§†é¢‘æ“ä½œç›¸åŒï¼Œåªæ”¾ä¸€ä¸ªäº†
if (++frameNow1 >= frameNum1 - 1) {
    frameNow1 = 0;
    VidCap1.set(cv::VideoCaptureProperties::CAP_PROP_POS_FRAMES, 0);
}
```
### 5. è¾¹ç¼˜å›¾æ˜¾ç¤º
ä»£ç æ¨¡æ¿é‡Œéƒ½æœ‰äº†
```cpp
// è®¾å®šçŠ¶æ€
enum VideoEffect
{
    noEdge, edge
};
VideoEffect vidEffect1 = VideoEffect::noEdge;    // è§†é¢‘1ç”»é¢çŠ¶æ€
VideoEffect vidEffect2 = VideoEffect::noEdge;    // è§†é¢‘2ç”»é¢çŠ¶æ€
```
```cpp
// ä¿®æ”¹çŠ¶æ€
case IDM_EDGE_EFFECT:
    if (vidEffect1 == VideoEffect::edge) {
        vidEffect1 = VideoEffect::noEdge;
    }
    else {
        vidEffect1 = VideoEffect::edge;
    }
    break;
case IDM_EDGE_EFFECT2:
    if (vidEffect2 == VideoEffect::edge) {
        vidEffect2 = VideoEffect::noEdge;
    }
    else {
        vidEffect2 = VideoEffect::edge;
    }
    break;
```
```cpp
// æ”¹å˜æ˜¾ç¤ºçŠ¶æ€
if (vidEffect1 == VideoEffect::edge)
{
    cv::Mat edgeY, edgeX;
    cv::Sobel(img1, edgeY, CV_8U, 1, 0);
    cv::Sobel(img1, edgeX, CV_8U, 0, 1);
    img1 = edgeX + edgeY;
}

InvalidateRect(hWnd, NULL, false);
```
### 6. å°è§†é¢‘æ‹–æ‹½å’Œç»˜åˆ¶
ç»˜åˆ¶çš„æ–¹æ³•ä¸Šè¯¾è®²è¿‡äº†ï¼Œé€šè¿‡`SetPixel()`å‡½æ•°æ¥å®ç°
æ‹–æ‹½ä¹Ÿæ²¡æœ‰éš¾åº¦ï¼Œå¦‚æœåœ¨å¤§ä¸‰ä¸Šå­¦æœŸé€‰è¿‡è®¡ç®—æœºå›¾å½¢å­¦çš„åŒå­¦åšè¿™ä¸ªåº”è¯¥å¾ˆç®€å•
æ€è·¯å°±æ˜¯è·å–åˆ°åˆå§‹ç‚¹å‡»ä½ç½®çš„åæ ‡ï¼Œåœ¨æ¯ä¸€å¸§è·å–ä¸€æ¬¡å½“å‰ä½ç½®ï¼Œè®¡ç®—å‡ºå·®å€¼ååŠ åœ¨å½“å‰åæ ‡ä¸Šå³å¯
```cpp
// å®šä¹‰å‚æ•°
// æ‹–æ‹½å‚æ•°
int lastX, lastY;                               // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶çš„ Xï¼ŒY
int nowX, nowY;                                 // æ¾å¼€é¼ æ ‡æ—¶çš„Xï¼ŒY
bool isDrag = false;                            // æ˜¯å¦åœ¨æ‹–æ‹½

// ç»˜åˆ¶å‚æ•°
int paintX[1000], paintY[1000];                 // åæ ‡ç‚¹
int paintIndex = 0;                             // ç»˜åˆ¶ç´¢å¼•
bool isPaint = false;                           // æ˜¯å¦åœ¨ç»˜åˆ¶
```
è¦ç”¨åˆ°çš„å‡ ä¸ªé¼ æ ‡è¾“å…¥ç›‘å¬
```cpp
case WM_LBUTTONDOWN: // å½“ç”¨æˆ·åœ¨å…‰æ ‡ä½äºçª—å£å·¥ä½œåŒºä¸­å¹¶ä¸”ç”¨æˆ·æŒ‰ä¸‹é¼ æ ‡å·¦é”®æ—¶å‘å¸ƒã€‚ å¦‚æœæœªæ•è·é¼ æ ‡ï¼Œåˆ™ä¼šå°†æ¶ˆæ¯å‘å¸ƒåˆ°å…‰æ ‡ä¸‹çš„çª—å£ã€‚ å¦åˆ™ï¼Œä¼šå°†æ¶ˆæ¯å‘é€åˆ°æ•è·äº†é¼ æ ‡çš„çª—å£ã€‚
    hdc2 = GetDC(hWnd);
    if (dragState == DragState::drag) {
        mouseX = GET_X_LPARAM(lParam);
        mouseY = GET_Y_LPARAM(lParam);
        cout << mouseX << " " << mouseY << endl;
        if (mouseX >= x2 && mouseY >= y2 && mouseX <= x2 + width2 && mouseY <= y2 + height2) {
            isDrag = true;
            lastX = mouseX;
            lastY = mouseY;
        }
    }
    if (paintState == PaintState::paint) {
        isPaint = true;
        paintX[paintIndex] = GET_X_LPARAM(lParam);
        paintY[paintIndex] = GET_Y_LPARAM(lParam);
    }
    break;
case WM_MOUSEMOVE: // ç›‘å¬å·¦é”®ç‚¹å‡»åç§»åŠ¨
    if (isPaint) {
        hdc2 = GetDC(hWnd);
        paintX[paintIndex] = GET_X_LPARAM(lParam);
        paintY[paintIndex] = GET_Y_LPARAM(lParam);
        paintIndex++;
    }
    if (isDrag) {
        nowX = GET_X_LPARAM(lParam);
        nowY = GET_Y_LPARAM(lParam);
    }
    break;
case WM_LBUTTONUP: // ç›‘å¬å·¦é”®æŠ¬èµ·
    hdc2 = GetDC(hWnd);
    //æ‹–åŠ¨å°çª—
    if (dragState == DragState::drag) {
        if (isDrag) {
            isDrag = false;
        }
    }
    if (paintState == PaintState::paint) {
        isPaint = false;
    }
    break
```
ä¹‹ååªéœ€è¦åœ¨ç»˜åˆ¶éƒ¨åˆ†è¿›è¡Œç®€å•çš„åæ ‡è®¡ç®—ã€é¢œè‰²ä¿®æ”¹å³å¯

## å¤šåª’ä½“å®éªŒå®Œç»“ï¼
**èƒ½åšçš„éƒ½åšäº†ï¼Œå¸Œæœ›æœ‰ä¸ªå¥½æˆç»©ï¼**